<?xml version="1.0" encoding="UTF-8" ?>
<configuration debug="true" scan="true" scanPeriod="60 seconds">
    <!--    https://logback.qos.ch/manual/layouts.html#conversionWord-->
    <property name="LOG_PATTERN" value="%date %level %thread %logger traceId=%mdc{traceId} spanId=%mdc{spanId} - %msg%n"/>
    <property name="LOG_FILE_NAME" value="queues-performance.log"/>
    <property name="LOG_FILE_DIR" value="logs"/>
    <property name="LOG_LEVEL" value="info"/>
    <property name="CATALINA_LOG_FILE_NAME" value="catalina.out"/>

    <appender name="console" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <appender name="rollingFileAppender" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE_DIR}/${LOG_FILE_NAME}</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
            <fileNamePattern>${LOG_FILE_DIR}/${LOG_FILE_NAME}.%i</fileNamePattern>
            <minIndex>1</minIndex>
            <maxIndex>10</maxIndex>
        </rollingPolicy>

        <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
            <maxFileSize>50MB</maxFileSize>
        </triggeringPolicy>

        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- We should use an async appender, passing on to a rolling file appender -->
    <appender name="async" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="rollingFileAppender"/>
        <queueSize>1000</queueSize>

        <!-- When using AsyncAppender, by default this has a discard threshold set to 20% of queue size.
             (http://logback.qos.ch/manual/appenders.html#asyncDiscardingThreshold)
             This means INFO messages will begin to be discarded when the queue exceeds 80%.
             This is to prevent the application from blocking during bursts of increased logging load.
             Ensure you size your queue correctly, and consider turning this threshold off,
             if discarding log messages is considered worse than blocking your application.
        -->
        <discardingThreshold>20</discardingThreshold>
        <includeCallerData>false</includeCallerData>
    </appender>

    <appender name="embeddedTomcatRollingFileAppender"
              class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE_DIR}/${CATALINA_LOG_FILE_NAME}</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
            <fileNamePattern>${LOG_FILE_DIR}/${CATALINA_LOG_FILE_NAME}.%i</fileNamePattern>
            <minIndex>1</minIndex>
            <maxIndex>10</maxIndex>
        </rollingPolicy>

        <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
            <maxFileSize>10MB</maxFileSize>
        </triggeringPolicy>

        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- We should use an async appender, passing on to a rolling file appender -->
    <appender name="asyncTomcat" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="embeddedTomcatRollingFileAppender"/>
        <queueSize>1000</queueSize>

        <!-- When using AsyncAppender, by default this has a discard threshold set to 20% of queue size.
             (http://logback.qos.ch/manual/appenders.html#asyncDiscardingThreshold)
             This means INFO messages will begin to be discarded when the queue exceeds 80%.
             This is to prevent the application from blocking during bursts of increased logging load.
             Ensure you size your queue correctly, and consider turning this threshold off,
             if discarding log messages is considered worse than blocking your application.
        -->
        <discardingThreshold>20</discardingThreshold>
        <includeCallerData>false</includeCallerData>
    </appender>

    <logger name="org.apache.tomcat">
        <appender-ref ref="asyncTomcat" additivity="false" level="${LOG_LEVEL}"/>
    </logger>

    <logger name="org.apache.catalina">
        <appender-ref ref="asyncTomcat" additivity="false" level="${LOG_LEVEL}"/>
    </logger>

    <root level="${LOG_LEVEL}">
        <appender-ref ref="console"/>
        <appender-ref ref="async"/>
    </root>

</configuration>
